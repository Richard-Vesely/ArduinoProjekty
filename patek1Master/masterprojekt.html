<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Arduino LCD/NeoPixel/TCS34725 ovládání</title>
  <style>
    :root { color-scheme: light dark; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 16px; line-height: 1.35;
    }
    h2 { margin: 18px 0 8px; }
    fieldset { border: 1px solid #8884; border-radius: 8px; padding: 12px; margin-bottom: 14px; }
    legend { padding: 0 6px; opacity: 0.8; }
    label { display: inline-block; margin: 6px 8px 6px 0; }
    input[type="text"], input[type="number"] { padding: 6px 8px; width: 220px; }
    input[type="range"] { width: 280px; vertical-align: middle; }
    button { padding: 8px 12px; margin: 4px 6px 4px 0; cursor: pointer; }
    select { padding: 6px 8px; }
    .row { display: flex; flex-wrap: wrap; gap: 10px 16px; align-items: center; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 10px 14px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    #log { width: 100%; height: 220px; white-space: pre; }
    .ok { color: #178037; }
    .err { color: #b00020; }
    .small { font-size: 12px; opacity: 0.8; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #8882; margin-left: 8px; }
  </style>
</head>
<body>
  <h1>Arduino ovladač: LCD / NeoPixel / TCS34725</h1>
  <div class="small">
    Funguje v Chrome/Edge (Web Serial). Připoj Arduino přes USB, klikni Připojit a povol přístup.
    <span id="status" class="pill">Nepřipojeno</span>
  </div>

  <fieldset>
    <legend>Připojení</legend>
    <div class="row">
      <button id="btnConnect">Připojit</button>
      <button id="btnDisconnect" disabled>Odpojit</button>
      <label>Rychlost: <b>115200</b> Bd</label>
    </div>
  </fieldset>

  <fieldset>
    <legend>LCD 20×4</legend>
    <div class="grid">
      <div><label>Řádek 1</label><br><input id="lcd1" type="text" maxlength="20" placeholder="Text pro řádek 1 (max 20)" /></div>
      <div><label>Řádek 2</label><br><input id="lcd2" type="text" maxlength="20" placeholder="Text pro řádek 2 (max 20)" /></div>
      <div><label>Řádek 3</label><br><input id="lcd3" type="text" maxlength="20" placeholder="Text pro řádek 3 (max 20)" /></div>
      <div><label>Řádek 4</label><br><input id="lcd4" type="text" maxlength="20" placeholder="Text pro řádek 4 (max 20)" /></div>
    </div>
    <div class="row">
      <button data-lcd-line="1">Odeslat řádek 1</button>
      <button data-lcd-line="2">Odeslat řádek 2</button>
      <button data-lcd-line="3">Odeslat řádek 3</button>
      <button data-lcd-line="4">Odeslat řádek 4</button>
    </div>
  </fieldset>

  <fieldset>
    <legend>NeoPixel – animace a jas</legend>
    <div class="row">
      <label>Animace:
        <select id="selShow">
          <option value="0">0 – Duha (Rainbow wheel)</option>
          <option value="1">1 – Theater chase</option>
          <option value="2">2 – Dýchání (Breathe)</option>
          <option value="3">3 – Kometa (Comet)</option>
          <option value="4">4 – Plné barvy (Solid cycle)</option>
        </select>
      </label>
      <button id="btnSetShow">Nastavit SHOW</button>
    </div>
    <div class="row">
      <label for="rngBri">Jas (0–255): <span id="lblBri">40</span></label>
      <input id="rngBri" type="range" min="0" max="255" step="1" value="40" />
      <button id="btnSetBri">Nastavit jas</button>
    </div>
  </fieldset>

  <fieldset>
    <legend>NeoPixel – jednotlivé LED a mazání</legend>
    <div class="row">
      <label>Prstenec:
        <select id="selRing">
          <option value="R12">R12 (12 LED) – pin 6</option>
          <option value="R8">R8 (8 LED) – pin 5</option>
        </select>
      </label>
      <label>Index LED:
        <input id="numIdx" type="number" min="0" value="0" style="width:90px" />
      </label>
      <label>Barva:
        <input id="inpColor" type="color" value="#ffffff" />
      </label>
      <button id="btnSetPix">Nastavit PIX</button>
      <button id="btnClrRing">Vymazat prstenec (CLR)</button>
    </div>
  </fieldset>

  <fieldset>
    <legend>TCS34725 senzor</legend>
    <div class="row">
      <button id="btnSenOn">SEN:ON</button>
      <button id="btnSenOff">SEN:OFF</button>
      <button id="btnLedOn">LED:ON</button>
      <button id="btnLedOff">LED:OFF</button>
      <button id="btnPing">PING</button>
    </div>
    <div class="row mono">
      Poslední RGB: <span id="rgbR">-</span>,<span id="rgbG">-</span>,<span id="rgbB">-</span>,C=<span id="rgbC">-</span>
    </div>
  </fieldset>

  <fieldset>
    <legend>Terminál (sériová linka)</legend>
    <div class="row">
      <input id="inpRaw" type="text" class="mono" placeholder="Vlastní příkaz, např. PIX:R12:0:255,0,0" style="width:420px" />
      <button id="btnSendRaw">Odeslat</button>
      <button id="btnClearLog">Smazat log</button>
    </div>
    <textarea id="log" class="mono" readonly></textarea>
  </fieldset>

  <noscript>Pro ovládání je potřeba povolit JavaScript.</noscript>

  <script>
    // Helper: line-oriented reader
    class LineBreakTransformer {
      constructor() { this.chunks = ""; }
      transform(chunk, controller) {
        this.chunks += chunk;
        const lines = this.chunks.split(/\r?\n/);
        this.chunks = lines.pop();
        for (const line of lines) controller.enqueue(line);
      }
      flush(controller) {
        if (this.chunks) controller.enqueue(this.chunks);
      }
    }

    const ui = {
      status: document.getElementById('status'),
      btnConnect: document.getElementById('btnConnect'),
      btnDisconnect: document.getElementById('btnDisconnect'),
      // LCD
      lcdInputs: [1,2,3,4].map(i => document.getElementById('lcd'+i)),
      lcdButtons: Array.from(document.querySelectorAll('[data-lcd-line]')),
      // Show / Brightness
      selShow: document.getElementById('selShow'),
      btnSetShow: document.getElementById('btnSetShow'),
      rngBri: document.getElementById('rngBri'),
      lblBri: document.getElementById('lblBri'),
      btnSetBri: document.getElementById('btnSetBri'),
      // Pixels
      selRing: document.getElementById('selRing'),
      numIdx: document.getElementById('numIdx'),
      inpColor: document.getElementById('inpColor'),
      btnSetPix: document.getElementById('btnSetPix'),
      btnClrRing: document.getElementById('btnClrRing'),
      // Sensor
      btnSenOn: document.getElementById('btnSenOn'),
      btnSenOff: document.getElementById('btnSenOff'),
      btnLedOn: document.getElementById('btnLedOn'),
      btnLedOff: document.getElementById('btnLedOff'),
      btnPing: document.getElementById('btnPing'),
      rgbR: document.getElementById('rgbR'),
      rgbG: document.getElementById('rgbG'),
      rgbB: document.getElementById('rgbB'),
      rgbC: document.getElementById('rgbC'),
      // Terminal
      inpRaw: document.getElementById('inpRaw'),
      btnSendRaw: document.getElementById('btnSendRaw'),
      btnClearLog: document.getElementById('btnClearLog'),
      log: document.getElementById('log'),
    };

    let port = null;
    let reader = null;
    let writer = null;
    let keepReading = false;

    function supportsWebSerial() {
      return 'serial' in navigator;
    }

    function setConnected(connected) {
      ui.btnConnect.disabled = connected;
      ui.btnDisconnect.disabled = !connected;
      ui.status.textContent = connected ? 'Připojeno' : 'Nepřipojeno';
      ui.status.style.background = connected ? '#17803733' : '#8882';
    }

    function log(line, cls = '') {
      const time = new Date().toLocaleTimeString();
      ui.log.value += `[${time}] ${line}\n`;
      ui.log.scrollTop = ui.log.scrollHeight;
    }

    function parseSensor(line) {
      // Expected: "RGB:r,g,b,c"
      if (!line.startsWith('RGB:')) return false;
      const rest = line.slice(4).trim();
      const parts = rest.split(',');
      if (parts.length < 4) return false;
      ui.rgbR.textContent = parts[0];
      ui.rgbG.textContent = parts[1];
      ui.rgbB.textContent = parts[2];
      ui.rgbC.textContent = parts[3];
      return true;
    }

    async function connect() {
      if (!supportsWebSerial()) {
        alert('Tento prohlížeč nepodporuje Web Serial. Použijte Chrome/Edge.');
        return;
      }
      try {
        port = await navigator.serial.requestPort({});
        await port.open({ baudRate: 115200 });
        const textDecoder = new TextDecoderStream();
        const textEncoder = new TextEncoderStream();
        const readableClosed = port.readable.pipeTo(textDecoder.writable);
        const writableClosed = textEncoder.readable.pipeTo(port.writable);

        reader = textDecoder.readable
          .pipeThrough(new TransformStream(new LineBreakTransformer()))
          .getReader();
        writer = textEncoder.writable.getWriter();

        keepReading = true;
        setConnected(true);
        log('Připojeno k sériovému portu.');
        readLoop().catch(err => {
          log('Chyba při čtení: ' + err.message, 'err');
        });
      } catch (err) {
        log('Připojení selhalo: ' + err.message, 'err');
        await disconnect(true);
      }
    }

    async function disconnect(silent = false) {
      keepReading = false;
      try {
        if (reader) { try { await reader.cancel(); } catch {} reader.releaseLock(); reader = null; }
        if (writer) { try { await writer.close(); } catch {} writer.releaseLock(); writer = null; }
        if (port) { try { await port.close(); } catch {} }
      } finally {
        port = null;
        setConnected(false);
        if (!silent) log('Odpojeno od sériového portu.');
      }
    }

    async function readLoop() {
      while (keepReading && reader) {
        const { value, done } = await reader.read();
        if (done) break;
        if (value != null && value !== '') {
          if (!parseSensor(value)) {
            log(value);
          }
        }
      }
    }

    async function sendLine(line) {
      if (!writer) {
        log('Nelze odeslat: nepřipojeno.', 'err');
        return;
      }
      const txt = line.replace(/\r?\n/g, '') + '\n';
      try {
        await writer.write(txt);
        log('> ' + line);
      } catch (err) {
        log('Chyba odeslání: ' + err.message, 'err');
      }
    }

    // UI handlers
    ui.btnConnect.addEventListener('click', connect);
    ui.btnDisconnect.addEventListener('click', () => disconnect(false));

    // LCD line send
    ui.lcdButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const lineNo = Number(btn.getAttribute('data-lcd-line'));
        const txt = ui.lcdInputs[lineNo - 1].value ?? '';
        // Arduino truncates/pads to 20 chars – mylní vstup také omezíme
        const out = txt.length > 20 ? txt.slice(0, 20) : txt;
        sendLine(`LCD:${lineNo}:${out}`);
      });
    });

    // SHOW mode
    ui.btnSetShow.addEventListener('click', () => {
      const mode = Number(ui.selShow.value);
      if (mode < 0 || mode > 4 || Number.isNaN(mode)) return;
      sendLine(`SHOW:${mode}`);
    });

    // Brightness
    ui.rngBri.addEventListener('input', () => {
      ui.lblBri.textContent = ui.rngBri.value;
    });
    ui.btnSetBri.addEventListener('click', () => {
      sendLine(`BRI:${ui.rngBri.value}`);
    });

    // Pixel set
    ui.btnSetPix.addEventListener('click', () => {
      const ring = ui.selRing.value; // R12 | R8
      const idx = Number(ui.numIdx.value);
      // Parse hex color #rrggbb
      const hex = ui.inpColor.value || '#ffffff';
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      sendLine(`PIX:${ring}:${idx}:${r},${g},${b}`);
    });

    // Clear ring
    ui.btnClrRing.addEventListener('click', () => {
      const ring = ui.selRing.value;
      sendLine(`CLR:${ring}`);
    });

    // Sensor controls
    ui.btnSenOn.addEventListener('click', () => sendLine('SEN:ON'));
    ui.btnSenOff.addEventListener('click', () => sendLine('SEN:OFF'));
    ui.btnLedOn.addEventListener('click', () => sendLine('LED:ON'));
    ui.btnLedOff.addEventListener('click', () => sendLine('LED:OFF'));
    ui.btnPing.addEventListener('click', () => sendLine('PING'));

    // Raw terminal
    ui.btnSendRaw.addEventListener('click', () => {
      const v = ui.inpRaw.value.trim();
      if (v) sendLine(v);
    });
    ui.inpRaw.addEventListener('keydown', e => {
      if (e.key === 'Enter') ui.btnSendRaw.click();
    });

    ui.btnClearLog.addEventListener('click', () => { ui.log.value = ''; });

    // Port disconnect handling
    if (supportsWebSerial()) {
      navigator.serial.addEventListener('disconnect', async (e) => {
        log('Zařízení bylo odpojeno.');
        await disconnect(true);
      });
    } else {
      log('Web Serial není podporován. Použijte Chrome/Edge.', 'err');
    }
  </script>
</body>
</html>